<!DOCTYPE html>
<html>

<head>
  <title>Hoyos usuario</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=500, user-scalable=no" />

  <link href="css/style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <style type="text/css">
      
      form {
          width: 100%;
          margin-top: 1%;
          margin-bottom: 1%;
      }

      form #q {
          width: 100%;
          text-align: left;
          padding: 5px 0px;
      }
  </style>

</head>

<body>
  <div class="row">
    <header class="bodyUsuario" style="text-align: center;
      color: #ffffff;
      font-family: cursive;
      border-radius: 10px;
      height: 100%;">
      <!-- <div class="col-lg-1" style="padding: 3%;float: right;
      font-size: 40px;
      
      /* margin-right: 28%; */" id="fecha"></div> -->

      <div class="col-lg-5" style="padding-top: 8%;
      padding-bottom: 8%;">
        <h3 style="padding: 4%;
            font-size: 45px;
            /* width: 100%; */
            margin-right: 36%;
            background-color: rgb(47 122 161 / 56%);">Espacio vecinal</h3>
      </div>
    </header>
  </div>

  <nav th:replace="layouts/fragmentoUsuarios :: nav"></nav>
  <hr>
  <div class="row" style="margin-top: 1%;">


    <div class="row col-lg-6 col-sm-12" th:object="${usuario}" style="
    padding: 3%;
    border-radius: 8px;
    margin-left: 5%;
    margin-bottom: 1%;
    ">
      <hr>
      <div class="row col-lg-12">
        <div class="col-4" th:if="${usuario.foto}">
          <img class="img-thumbnail  float-left" style="border-radius: 8px;" th:src="@{'/uploads/'+${usuario.foto}}"
            th:alt="${usuario.foto}" />
        </div>
        <div class="col-lg-8" style=" font-family: serif;
        text-align: center;
        border-radius: 8px;
		margin-top: 7%;">
          <h3 th:if="${fotoConHuecos}" th:text="${fotoConHuecos}" style="color: rgb(0, 0, 0);"></h3>
          <p style="font-size: 24px;
          color: rgb(0, 0, 0);
          padding: 5%;background-color: #7f9eff;" th:if="${usuario.nombre}"
            th:text="'Hola '+${usuario.nombre}+', construyamos pueblo entre todos y todas.'"></p>

        </div>
        <!-- <div class="container" th:object="${unUsuario}">
                <legend>Informacion Usuario</legend> -->

      </div>

      <!-- Conjunto to de botones  -->
      <div class="row" style="margin-top: 3%;">
        <hr>
        <!-- Button trigger modal -->
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-2" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a href="" id="botonesRutas" style="text-decoration: none;margin-top: 3%;font-size: 20px;"
              data-bs-toggle="modal" data-bs-target="#staticBackdrop">
              Realizar Propuesta
            </a>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Realizar propuesta: Te saldrá un desplegable para realizar una propuesta, tendrás que rellenar el título,
              el
              contenido y enviar la propuesta.
            </p>
          </div>
        </div>
        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-2" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <form th:action="@{/misPropuestas}" th:object="${usuario}" class="text-dark" method="get">
              <input type="hidden" id="idUsuario" th:field="*{idUsuario}" class="form-control">

              <input type="submit" value="Tus Propuestas" class="link " style="font-size: 20px;border: none;">

            </form>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Tus propuesta: Clicando aquí, entrarás en "tus propuestas", donde podrás editarlas y borrarlas.
              Los administradores también podrán borrarlas si ya se han llevado a cabo o si pierden validez.
            </p>
          </div>
        </div>
        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-2" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a th:href="@{'/mercadillo?idUsuario='+${usuario.idUsuario}}" id="botonesRutas"
              style="text-decoration: none;font-size: 20px;">
              Compra Venta y Servicios
            </a>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Compra Venta y Servicios: Clicando aquí, entrarás en "Compra Venta y Servicios", este es un espacio para
              que la gente pueda poner sus casas, terrenos ,pajares, ovejas, sillas, mesas, etc, en venta, pero tambien
              para que ofrezcan sus
              servicios, como por ejemplo servicios de albañileria, fontaneria, restauracion de muebles, clases de
              ingles, etc.

            </p>
          </div>
        </div>
        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-2" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a th:href="@{'/miMercadillo?idUsuario='+${usuario.idUsuario}}" id="botonesRutas"
              style="text-decoration: none;font-size: 20px;">
              Tu Compra Venta y Servicios
            </a>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Tu Compra Venta y Servicios: Clicando aquí, entrarás en "Tu Compra Venta y Servicios", desde aquí podras
              editar tus productos(cambiar el precio, por ejemplo), tambien podras borrar tus ofertas si ya las has
              vendido
              o por otra razon.

            </p>
          </div>
        </div>

        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-4" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a type="submit" id="botonesRutas" style="text-decoration: none;font-size: 20px;" th:href="@{/subirFotos}">
              Subir Foto a
              Galeria</a>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Subir foto a galería: Accederás a la página de subir fotografias a la galería de fotos de Cuevas de
              Ayllón. Esto esta esta pensado para que todos los vecinos promocionemos nuestro propio pueblo.
            </p>
          </div>
        </div>
        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-2" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a href="" id="botonesRutas" style="text-decoration: none;font-size: 20px;" data-bs-toggle="modal"
              data-bs-target="#staticBackdrop5">
              Recibir Notificaciones
            </a>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Recibir Notificaciones: Te saldrá un desplegable para que decidas si quieres recibir notificaciones cuando
              alguien realiza una propuesta.Si quieres dejar de recibirlas clica en "Dejar de recibir notificaciones".

            </p>
          </div>
        </div>



        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-4" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a href="" id="botonesRutas" style="text-decoration: none;margin-top: 3%;font-size: 20px;"
              data-bs-toggle="modal" data-bs-target="#staticBackdrop1">
              Editar Usuario
            </a>
          </div>
          <div class="col-lg-4" style="width: 100%;">
            <p>
              Editar usuario: Te saldrá un desplegable para editar tus datos de usuario.
            </p>
          </div>
        </div>

        <hr>
        <div class="row" style="margin-top: 3%;">
          <div class="col-lg-4" style="width: 100%;margin-bottom: 7%;
          background: beige;">
            <a href="" id="botonesRutas" style="text-decoration: none;margin-top: 3%;font-size: 20px;"
              data-bs-toggle="modal" data-bs-target="#staticBackdrop2">
              Darse de Baja
            </a>
          </div>
          <div class="col-lg-4" style="width: 100%;">

            <p>
              Darte de baja: Te saldrá un desplegable para darte de baja.
            </p>

          </div>
        </div>


        </br>
        <hr>
      </div>
    </div>

    <div class="col-lg-4 col-sm-12" style="overflow: scroll;
    height: 1224px;
    margin-bottom: 10%;
    margin-left: 3%;
    margin-top: 2%;" id="todasPropuestas">
      <hr>
      <h2
        style="margin-top: 13%;padding: 3%;color: rgb(0, 0, 0); font-family: -webkit-body;padding: 10px; font-size: 24px;margin-left: 3%;background-color: #7f9eff;">
        Aquí
        tienes todas las propuestas, las tuyas y las de los demás vecinos.</h2>

      <h2
        style="padding: 3%;color: rgb(0, 0, 0); font-family: -webkit-body;padding: 10px; font-size: 24px;margin-left: 3%;background-color: #7f9eff;">
        Clicando sobre el nombre, podras leer la propuesta, comentarla y votarla.</h2>
      </br>
      <form>
        <input class="form-control" type="text" id="q" placeholder="Buscar......" onkeyup="search()">
    </form>

    </div>


  </div>

  <!-- Darse de baja ventana Modal -->


  <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel2">Darse de Baja</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form th:action="@{/doBorrarDesdeUsuario}" th:object="${usuario}" class="text-dark" style="width: 250%;
           padding: 30px;" method="post">
            <input type="hidden" id="idUsuario" th:field="*{idUsuario}" class="form-control">
            <div class=" col-sm-2">
              <input type="submit" value="Darse de baja" class="btn btn-primary">
            </div>
          </form>


        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        </div>

      </div>
    </div>
  </div>


  <!-- Realizar propuesta ventana Modal -->


  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">

          <div>
            <h3 class="text-start">Realiza tu propuesta para que la conozcan los demás vecinos</h3>
          </div>
          <div id="propuestaRelizada"></div>
          <div th:text="${propuestaRelizada}"></div>

          <h2 id="propuestaExistente"></h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label form="titulo" class="col-form-label col-sm-2" maxlength="50">Titulo</label>
          <input type="text" id="titulo" class="form-control">
          <textarea id="texto" name="texto" rows="4" cols="50" style=" height: 180px; width: 98%; margin-top: 10px;"
            maxlength="500">
            </textarea>
          <button type="button" class="btn btn-primary" id="enviarPropuesta">enviar propuestas</button>

        </div>
        <!-- <h2 id="propuestaRelizada"></h2>
          <h2 id="propuestaExistente"></h2> -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="refrescar" data-bs-dismiss="modal">Close</button>

        </div>

      </div>
    </div>
  </div>


  <!-- Editar Usuario ventana Modal -->


  <div class="modal fade" id="staticBackdrop1" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel1">Editar Usuario</h5>

          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form th:action="@{/editarUsuario}" th:object="${usuario}" class="text-dark" style="width: 250%;
        padding: 30px;" method="post" enctype="multipart/form-data">
            <div class="row col-sm-4">
              <label form="nombre" class="col-form-label col-sm-2" th:text="${nombre}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="text" id="nombre" th:field="*{nombre}" class="form-control" maxlength="20"
                placeholder="Nombre">
              <div th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="alert alert-danger">
              </div>
            </div>
            <div class="row col-sm-4">
              <label form="apellido1" class="col-form-label col-sm-2" th:text="${apellido1}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="text" id="apellido1" th:field="*{apellido1}" maxlength="20" class="form-control"
                placeholder="Primer Apellido">
              <div th:if="${#fields.hasErrors('apellido1')}" th:errors="*{apellido1}" class="alert alert-danger">
              </div>
            </div>
            <div class="row col-sm-4">
              <label form="apellido2" class="col-form-label col-sm-2" th:text="${apellido2}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="text" id="apellido2" th:field="*{apellido2}" maxlength="20" class="form-control"
                placeholder="Segundo Apellido">
              <div th:if="${#fields.hasErrors('apellido2')}" th:errors="*{apellido2}" class="alert alert-danger">
              </div>
            </div>
            <div class="row col-sm-4">
              <label form="email" class="col-form-label col-sm-2" th:text="${email}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="text" id="email" th:field="*{email}" class="form-control" placeholder="@Email">
              <div th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="alert alert-danger">
              </div>
            </div>
            <div class="row col-sm-4">
              <label form="direccion" class="col-form-label col-sm-6" th:text="${direccion}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="text" id="direccion" th:field="*{direccion}" class="form-control"
                placeholder="Direccion del Pueblo">
              <div th:if="${#fields.hasErrors('direccion')}" th:errors="*{direccion}" class="alert alert-danger">
              </div>
            </div>
            <div class="row col-sm-4">
              <label form="file" class="col-form-label col-sm-2" th:text="${foto}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="file" id="foto" name="file" class="form-control">
              <div th:if="${#fields.hasErrors('foto')}" th:errors="*{foto}" class="alert alert-danger">
              </div>
            </div>
            <div class="row col-sm-4">
              <label form="password" class="col-form-label col-sm-2" th:text="${Password}"></label>
            </div>
            <div class="row col-sm-4">
              <input type="password" id="password" th:field="*{password}" class="form-control" placeholder="Contraseña">
              <div th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="alert alert-danger">
              </div>
            </div></br></br>
            <input type="hidden" id="idUsuario" th:field="*{idUsuario}" class="form-control">
            <div class=" col-sm-2">
              <input type="submit" id="enviarAlta" value="ENVIAR" class="btn btn-primary">
            </div>

          </form>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="refrescar" data-bs-dismiss="modal">Close</button>

        </div>

      </div>
    </div>
  </div>

  <!-- EditarRecibir notificaciones  -->

  <div class="modal fade" id="staticBackdrop5" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-header">

          <h5 class="modal-title" id="staticBackdropLabel5">Si quieres recibir una notificacion por mail cada vez
            que un vecino realiza una propuesta, pulsa "Recibir notificaciones". si estabas recibibiendo
            notificaciones
            y quieres deja de hacerlo, pulsa "Dejar de recibir notificaciones". Si no pulsas "Recibir
            notificaciones"
            no recibirás notificación alguna.</h5>

        </div>
        <div class="modal-header">
          <h4 th:text="'En esto momentos  ' + ${usuario.notificacion} + ' recibe notificaciones '"></h4>
        </div>
        <div class="modal-body">
          <div style="display: inline-flex;">
            <form th:action="@{/recibirNotificacion}" th:object="${usuario}" class="text-dark" style="width: 250%;
  padding-left: 1%;" method="post" enctype="multipart/form-data">



              <input type="hidden" id="idUsuario" th:field="*{idUsuario}" class="form-control">
              <div class="row col-sm-13">
                <input type="submit" id="enviarAlta" value="Recibir Notificaciones" class="btn btn-primary">
              </div>

            </form>
            <form th:action="@{/noRecibirNotificacion}" th:object="${usuario}" class="text-dark" style="width: 250%;
  padding-left: 9%;" method="post" enctype="multipart/form-data">


              <input type="hidden" id="idUsuario" th:field="*{idUsuario}" class="form-control">
              <div class="row col-sm-13">
                <input type="submit" id="enviarAlta" value="Dejar de recibir notificaciones" class="btn btn-primary">
              </div>

            </form>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="refrescar" data-bs-dismiss="modal">Close</button>

        </div>

      </div>
    </div>
  </div>


  <!-- </div> -->


  <!-- Tabla de propuestas -->





  <!-- </div> -->
  <script th:src="@{/js/jquery.min.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
    crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

</body>

<script>

  $(document).ready(function () {
    $.ajax({

      type: 'get',
      //url: "https://cuevas-de-ayllon.com/propuesta",
      url: "propuesta",




    }).done(function (data) {
      console.log("El valor devuelto por propuestas es: " + data);
      var html2 = '';
      html2 += '<hr>';
      html2 += '<table  class="table table-responsive table-hover table-striped table-borderless" style="-moz-border-radius: 10px;text-decoration: none; text-align: center;">';
      html2 += '<thead>';
      html2 += '<tr> ';
      html2 += '<th style="color:black;font-family: sans-serif;">TITULO DE LAS PROPUESTAS</th>';
      html2 += '</tr>';
      html2 += '</thead>';

      html2 += '<tbody id="the_table_body"> ';
      for (var i = 0; i < data.length; i++) {

        console.log('estamos en la tabla', data)
        html2 += '<tr> ';
        html2 += '<div class="row">';
        html2 += '<div class="col-xs-5">';
        html2 += "<td style='padding:4%'>";
        html2 += "<a  style='text-decoration: none;color:black;font-family: sans-serif;'  href=comentarios?idPropuesta=" + data[i].idPropuesta + ">" + data[i].titulo.toUpperCase() + "</a></td>";
        html2 += '</div>';
        html2 += '</div>';
        html2 += "</tr>"

      }
      html2 += '<tr> ';
      html2 += '<td id="anadirPropuesta"> </td>';
      html2 += "</tr>";
      html2 += '</tbody>';
      html2 += " </table>";
      $('#todasPropuestas').append(html2);

    });
  })

  $('#enviarPropuesta').on('click', function () {
    // var div = document.getElementById('todasPropuestas');
    // while (div.firstChild) {
    //   div.removeChild(div.firstChild);
    // }


    $.ajax({
      type: 'POST',
      url: "propuesta",
      //url: "https://cuevas-de-ayllon.com/propuesta",
      data: { 'propuesta': $('#texto').val(), 'titulo': $('#titulo').val() },
      timeout: 5000,


    }).done(function (data) {
      var propuestaExito = "La propuesta se ha añadido con éxito";
      var propuestaNoExito = "La propuesta ya existe, cierre la ventana y vuelva a realizar la propuesta cambiando el nombre, sentimos las molestias";
      console.log("El valor devuelto por la añadir propuestaq es este: " + data.titulo);
      var propuestaRealizada1 = '';
      var propuestaRealizada = '';
      if (jQuery.trim(data.titulo) !== "propuesta Existente") {

        console.log("El valor devuelto por  añadir propuesta es este: " + data);
        var html2 = '';
        console.log('estamos en la tabla', data)
        html2 += "<a class='btn btn-dark' href=comentarios?idPropuesta=" + data.idPropuesta + ">" + data.titulo + "</a>";
        $('#anadirPropuesta').append(html2);

        propuestaRealizada += '';
        propuestaRealizada += '<div class="container col-lg-3" style="background-color: white;font-size: 20px;padding: 1%;">'
        propuestaRealizada += 'La propuesta se ha añadido con éxito';
        propuestaRealizada += '</div>'
        console.log("Añadimos el mensaje de exito: ", propuestaRealizada);

        $('#staticBackdrop').append(propuestaRealizada);
        $.ajax({
          type: 'GET',
          url: "enviarNotificacion",
          //url: "https://cuevas-de-ayllon.com/enviarNotificacion",

          timeout: 5000,


        })

      } else if (jQuery.trim(data.titulo) === "propuesta Existente") {
        var propuestaRealizada1 = '';
        propuestaRealizada1 += '';
        propuestaRealizada1 += '<div  class="container col-lg-3" style="background-color: white;font-size: 20px;padding: 1%;">'
        propuestaRealizada1 += 'La propuesta ya existe';
        propuestaRealizada1 += 'cierre la ventana y vuelva a realizar la propuesta cambiando el nombre,';
        propuestaRealizada1 += 'sentimos la molestias';

        propuestaRealizada += '</div>'
        console.log("Añádimos el mensaje propuesta existente: ", propuestaRealizada1);

        $('#staticBackdrop').append(propuestaRealizada1);

      }
    });
  })

  $('#refrescar').on('click', function () {
    propuestaRealizada1 = '';
    propuestaRealizada = '';
    // history.back();
    window.location.replace("usuario");
    $("#staticBackdrop").empty();
    // $('#staticBackdrop').append(propuestaRealizada1);
    // $('#staticBackdrop').append(propuestaRealizada);
  });





</script>
<script>
  $('#enviaridUsuario').on('click', function () {
    // var div = document.getElementById('todasPropuestas');
    // while (div.firstChild) {
    //   div.removeChild(div.firstChild);
    // }
    var idUsuario = $('#idUsuario').val();

    console.log

    $.ajax({
      type: 'GET',
      url: "mercadillo",
      //url: "https://cuevas-de-ayllon.com/mercadillo",
      data: { 'idUsuario': idUsuario },
      timeout: 5000,


    })
  });
</script>
<script type="text/javascript">
  function search() {
    var num_cols, display, input, filter, table_body, tr, td, i, txtValue;
    num_cols = 3;
    input = document.getElementById("q");
    filter = input.value.toUpperCase();
    table_body = document.getElementById("the_table_body");
    tr = table_body.getElementsByTagName("tr");

    for (i = 0; i < tr.length; i++) {
      display = "none";
      for (j = 0; j < num_cols; j++) {
        td = tr[i].getElementsByTagName("td")[j];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            display = "";
          }
        }
      }
      tr[i].style.display = display;
    }
  }		
</script>

</html>